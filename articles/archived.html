<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Working with archived data • gtfsrealtime</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Working with archived data">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">gtfsrealtime</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.0.1</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/archived.html">Working with archived data</a></li>
    <li><a class="dropdown-item" href="../articles/positions.html">Vehicle positions</a></li>
  </ul>
</li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Working with archived data</h1>
            
      

      <div class="d-none name"><code>archived.Rmd</code></div>
    </div>

    
    
<!--
This file is called .Rmd.orig because it takes forever to run. So instead of having
GH actions render it every time, we pre-render it to archived.Rmd with all R code and
figures created, and re-render it occasionally (precompile.R will do this).
-->
<p>A single GTFS-realtime file is a snapshot of the state of a transit
system in time. However, from an analytical perspective it is often more
useful to archive GTFS-realtime feeds over time (once every minute is
common), and then analyze a whole slew of GTFS-realtime feeds at
once.</p>
<p>This vignette discusses how to aggregate multiple vehicle position
feeds and get a table of vehicle positions over the course of (e.g.) a
full day, and do some basic analysis with it.</p>
<div class="section level2">
<h2 id="the-data">The data<a class="anchor" aria-label="anchor" href="#the-data"></a>
</h2>
<p><img src="figures/nyc_bus_anim.gif" class="r-plt" alt="Animation of a day of buses in NYC; each bus is a black dot, and its position is shown every minute.">
In this vignette, we will work with one day of archived GTFS-realtime
position data from the <a href="https://bustime.mta.info/wiki/Developers/Index" class="external-link">MTA New York City
Transit Bus realtime feed</a>. These positions over the course of the
day are shown above; at the end of this vignette we will see how to make
this animation.</p>
<p>This data is too large to include with the <code>gtfsrealtime</code>
package, so <a href="https://files.indicatrix.org/gtfsrealtime-r/nyc-bus-demo.zip" class="external-link">it
is available for download here</a>. The R code below will download and
unzip one day of GTFS-realtime vehicle position files, and place it in a
directory <code>nyc-bus-demo</code> in the current working
directory.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/message.html" class="external-link">suppressMessages</a></span><span class="op">(</span><span class="op">{</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/files2.html" class="external-link">dir.exists</a></span><span class="op">(</span><span class="st">"nyc-bus-demo"</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">zipfile</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempfile</a></span><span class="op">(</span>fileext <span class="op">=</span> <span class="st">".zip"</span><span class="op">)</span></span>
<span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/utils/download.file.html" class="external-link">download.file</a></span><span class="op">(</span></span>
<span>      <span class="st">"https://files.indicatrix.org/gtfsrealtime-r/nyc-bus-demo.zip"</span>,</span>
<span>      <span class="va">zipfile</span></span>
<span>    <span class="op">)</span></span>
<span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/utils/unzip.html" class="external-link">unzip</a></span><span class="op">(</span><span class="va">zipfile</span>, exdir<span class="op">=</span><span class="st">"."</span><span class="op">)</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/files.html" class="external-link">file.remove</a></span><span class="op">(</span><span class="va">zipfile</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">}</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="load-libraries">Load libraries<a class="anchor" aria-label="anchor" href="#load-libraries"></a>
</h2>
<p>Next, we need to load libraries. We use quite a few different
libraries in this vignette; not all will be required for every analysis.
<code>ggplot2</code>, <code>dplyr</code>, <code>lubridate</code>, and
<code>purrr</code> are all part of the tidyverse and could alternately
be loaded with <code><a href="https://tidyverse.tidyverse.org" class="external-link">library(tidyverse)</a></code>.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="http://projects.indicatrix.org/gtfsrealtime-r/" class="external-link">gtfsrealtime</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://purrr.tidyverse.org/" class="external-link">purrr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://r-datatable.com" class="external-link">data.table</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyr.tidyverse.org" class="external-link">tidyr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://lubridate.tidyverse.org" class="external-link">lubridate</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://r-spatial.github.io/sf/" class="external-link">sf</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://r-rust.r-universe.dev/gifski" class="external-link">gifski</a></span><span class="op">)</span></span></code></pre></div>
<p>Next, we read in multiple GTFS-realtime files, and stack them all
together. There are 1,440 GTFS-realtime files, from 3:00 AM local time
on January 28, 2026 to 2:59 AM local time on January 29. We use the
<code>Sys.glob</code> function to match multiple files - in this case,
every vehicle position file in <code>nyc-bus-demo</code>. The
<code>*</code> means “anything”, so this will match any file that starts
with <code>nyc-bus-demo/vehicle-positions-</code> and ends with
<code>.pb.bz2</code>. (<code>.pb.bz2</code> means a Protocol Buffers
file, the underlying format of GTFS-realtime, compressed using
<code>bzip2</code>. ‘gtfsrealtime’ can load files compressed with
<code>gzip</code> or <code>bzip2</code> directly). We use the
<code>map</code> function from ‘purrr’ to apply a function to each file
name, and the <code>rbindlist</code> function to stack all of the
records into a single <code>data.table</code>.</p>
</div>
<div class="section level2">
<h2 id="read-data">Read data<a class="anchor" aria-label="anchor" href="#read-data"></a>
</h2>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">positions</span> <span class="op">=</span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html" class="external-link">map</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/Sys.glob.html" class="external-link">Sys.glob</a></span><span class="op">(</span><span class="st">"nyc-bus-demo/vehicle-positions-*.pb.bz2"</span><span class="op">)</span>,</span>
<span>    <span class="va">read_gtfsrt_positions</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/data.table/man/rbindlist.html" class="external-link">rbindlist</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">positions</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##               id latitude longitude  bearing odometer speed                            trip_id route_id direction_id</span></span>
<span><span class="co">##           &lt;char&gt;    &lt;num&gt;     &lt;num&gt;    &lt;num&gt;    &lt;num&gt; &lt;num&gt;                             &lt;char&gt;   &lt;char&gt;        &lt;num&gt;</span></span>
<span><span class="co">## 1: MTA NYCT_7116 40.67004 -73.84773 343.8108       NA    NA  EN_A6-Weekday-SDon-013500_B15_103      B15            0</span></span>
<span><span class="co">## 2: MTA NYCT_8446 40.70428 -73.79269 310.4622       NA    NA   JA_A6-Weekday-SDon-016700_Q5_201       Q5            0</span></span>
<span><span class="co">## 3: MTA NYCT_9760 40.74069 -73.99020 234.0276       NA    NA   MV_A6-Weekday-SDon-013000_M2_202       M2            1</span></span>
<span><span class="co">## 4: MTA NYCT_7160 40.71404 -73.95068 359.4692       NA    NA         FP_M6-Weekday-017500_L90_5      L90            0</span></span>
<span><span class="co">## 5: MTA NYCT_5314 40.81609 -73.91773 341.5651       NA    NA WF_A6-Weekday-SDon-015000_BX19_301     BX19            0</span></span>
<span><span class="co">## 6: MTA NYCT_5338 40.86142 -73.89084 329.7436       NA    NA  KB_A6-Weekday-SDon-015500_BX9_601      BX9            1</span></span>
<span><span class="co">##    start_time start_date schedule_relationship stop_id current_stop_sequence current_status  timestamp congestion_level</span></span>
<span><span class="co">##        &lt;char&gt;     &lt;char&gt;                &lt;fctr&gt;  &lt;char&gt;                 &lt;num&gt;         &lt;fctr&gt;      &lt;num&gt;           &lt;fctr&gt;</span></span>
<span><span class="co">## 1:       &lt;NA&gt;   20260128                  &lt;NA&gt;  904253                    NA           &lt;NA&gt; 1769587226             &lt;NA&gt;</span></span>
<span><span class="co">## 2:       &lt;NA&gt;   20260128                  &lt;NA&gt;  503967                    NA           &lt;NA&gt; 1769587224             &lt;NA&gt;</span></span>
<span><span class="co">## 3:       &lt;NA&gt;   20260128                  &lt;NA&gt;  400330                    NA           &lt;NA&gt; 1769587206             &lt;NA&gt;</span></span>
<span><span class="co">## 4:       &lt;NA&gt;   20260128                  &lt;NA&gt;  302319                    NA           &lt;NA&gt; 1769587202             &lt;NA&gt;</span></span>
<span><span class="co">## 5:       &lt;NA&gt;   20260128                  &lt;NA&gt;  103748                    NA           &lt;NA&gt; 1769587224             &lt;NA&gt;</span></span>
<span><span class="co">## 6:       &lt;NA&gt;   20260128                  &lt;NA&gt;  104102                    NA           &lt;NA&gt; 1769587202             &lt;NA&gt;</span></span>
<span><span class="co">##        occupancy_status occupancy_percentage    vehicle_id vehicle_label vehicle_license_plate</span></span>
<span><span class="co">##                  &lt;fctr&gt;                &lt;num&gt;        &lt;char&gt;        &lt;char&gt;                &lt;char&gt;</span></span>
<span><span class="co">## 1: MANY_SEATS_AVAILABLE                   NA MTA NYCT_7116          &lt;NA&gt;                  &lt;NA&gt;</span></span>
<span><span class="co">## 2:                 &lt;NA&gt;                   NA MTA NYCT_8446          &lt;NA&gt;                  &lt;NA&gt;</span></span>
<span><span class="co">## 3:                 &lt;NA&gt;                   NA MTA NYCT_9760          &lt;NA&gt;                  &lt;NA&gt;</span></span>
<span><span class="co">## 4:                 &lt;NA&gt;                   NA MTA NYCT_7160          &lt;NA&gt;                  &lt;NA&gt;</span></span>
<span><span class="co">## 5:                 &lt;NA&gt;                   NA MTA NYCT_5314          &lt;NA&gt;                  &lt;NA&gt;</span></span>
<span><span class="co">## 6:                 &lt;NA&gt;                   NA MTA NYCT_5338          &lt;NA&gt;                  &lt;NA&gt;</span></span></code></pre>
<p>We have read 2.8 million vehicle observations:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">positions</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] 2825902</span></span></code></pre>
</div>
<div class="section level2">
<h2 id="clean-data">Clean data<a class="anchor" aria-label="anchor" href="#clean-data"></a>
</h2>
<p>Some of the observations are duplicates, as not every bus reports in
every minute. We can identify these based on timestamp and vehicle ID,
and go down to a single record per report. This uses ‘data.table’
syntax, which is somewhat more obtuse than ‘tidyverse’, but orders of
magnitude faster - important with large datasets such as this.</p>
<p>The syntax below groups by timestamp and vehicle ID (the last part).
It then takes the first row of each SubDataset
(<code>.SD[1]</code>).</p>
<p>Note that, at least in the New York data, there are sometimes
multiple reports with the same timestamp and vehicle ID but different
locations. This is some type of data error, so I just pick the first
reported position for a given time.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">positions</span> <span class="op">=</span> <span class="va">positions</span><span class="op">[</span>, <span class="va">.SD</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"timestamp"</span>, <span class="st">"vehicle_id"</span><span class="op">)</span><span class="op">]</span></span></code></pre></div>
<p>The timestamp column is a <a href="https://en.wikipedia.org/wiki/Unix_time" class="external-link">Unix timestamp</a>,
measuring seconds since January 1, 1970 at 00:00:00 UTC. We convert it
here to a datetime object, and adjust the timezone, since Unix time is
always recorded in UTC.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">positions</span><span class="op">[</span>, <span class="va">timestamp</span> <span class="op">:=</span> <span class="fu"><a href="https://lubridate.tidyverse.org/reference/with_tz.html" class="external-link">with_tz</a></span><span class="op">(</span><span class="fu"><a href="https://lubridate.tidyverse.org/reference/as_date.html" class="external-link">as_datetime</a></span><span class="op">(</span><span class="va">timestamp</span><span class="op">)</span>, <span class="st">"America/New_York"</span><span class="op">)</span><span class="op">]</span></span></code></pre></div>
<p>The data are spatial, so we can convert to an <code>sf</code> object
for remaining spatial analyses. The data in GTFS realtime is always WGS
84 latitude/longitude, so we specify that the CRS is 4326 when creating
the dataset, then immediately project to 32118, State Plane New York
Long Island.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">positions</span> <span class="op">=</span> <span class="va">positions</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_as_sf.html" class="external-link">st_as_sf</a></span><span class="op">(</span>coords<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"longitude"</span>, <span class="st">"latitude"</span><span class="op">)</span>, crs<span class="op">=</span><span class="fl">4326</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_transform.html" class="external-link">st_transform</a></span><span class="op">(</span><span class="fl">32118</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="getting-a-snapshot-state-at-any-given-time">Getting a snapshot state at any given time<a class="anchor" aria-label="anchor" href="#getting-a-snapshot-state-at-any-given-time"></a>
</h2>
<p>To get the positions of all vehicles at any given time, we want to
grab all position reports within (say) the last five minutes, and get
the most recent one for each vehicle. We can write a function to do
this:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">snapshot_positions</span> <span class="op">=</span> <span class="kw">function</span> <span class="op">(</span><span class="va">positions</span>, <span class="va">time</span>, <span class="va">tolerance_mins</span><span class="op">=</span><span class="fl">5</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># sf uses tidyverse syntax rather than data.table</span></span>
<span>  <span class="va">positions</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">timestamp</span> <span class="op">&lt;=</span> <span class="va">time</span> <span class="op">&amp;</span> <span class="va">timestamp</span> <span class="op">&gt;=</span> <span class="va">time</span> <span class="op">-</span> <span class="fu"><a href="https://lubridate.tidyverse.org/reference/period.html" class="external-link">minutes</a></span><span class="op">(</span><span class="va">tolerance_mins</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">vehicle_id</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/slice.html" class="external-link">slice_max</a></span><span class="op">(</span><span class="va">timestamp</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>And we can use that function to get all vehicle positions at 8 AM on
the day our data were collected:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># note! important to specify correct time zone</span></span>
<span><span class="va">pos_8am</span> <span class="op">=</span> <span class="fu">snapshot_positions</span><span class="op">(</span><span class="va">positions</span>, <span class="fu"><a href="https://lubridate.tidyverse.org/reference/ymd_hms.html" class="external-link">ymd_hms</a></span><span class="op">(</span><span class="st">"2026-01-28 8:00:00"</span>, tz <span class="op">=</span> <span class="st">"America/New_York"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>We could plot those positions:</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">pos_8am</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html" class="external-link">geom_sf</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="co"># theme_void removes all plot elements</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_void</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<div class="figure">
<img src="figures/unnamed-chunk-9-1.png" alt="Plot showing several thousand dots representing buses, in the general shape of New York City, on a white background."><p class="caption">
plot of chunk unnamed-chunk-9
</p>
</div>
</div>
<div class="section level2">
<h2 id="animating-positions">Animating positions<a class="anchor" aria-label="anchor" href="#animating-positions"></a>
</h2>
<p>Now we get to making the figure we saw at the top. We will render one
“frame” (plot of bus locations) for each minute, and then use <a href="https://cran.r-project.org/web/packages/gifski/index.html" class="external-link">gifski</a>
to convert to an animated GIF. First, we will create a temporary
directory to hold those frames:</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">framedir</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempfile</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/files2.html" class="external-link">dir.create</a></span><span class="op">(</span><span class="va">framedir</span><span class="op">)</span></span></code></pre></div>
<p>Next, we will render the plots to image files in that directory, one
at a time. We have data from 3am NYC time 2026-01-28 to 3am 2026-01-29,
so we will have 1,440 frames one minute apart.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># as.list is necessary to preserve column type:</span></span>
<span><span class="co"># https://stackoverflow.com/questions/77838146</span></span>
<span><span class="va">times</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">as.list</a></span><span class="op">(</span><span class="fu"><a href="https://lubridate.tidyverse.org/reference/ymd_hms.html" class="external-link">ymd_hms</a></span><span class="op">(</span><span class="st">"2026-01-28 03:00:00"</span>, tz<span class="op">=</span><span class="st">"America/New_York"</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://lubridate.tidyverse.org/reference/period.html" class="external-link">minutes</a></span><span class="op">(</span><span class="fl">0</span><span class="op">:</span><span class="fl">1440</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># get the bounding box of all positions over the course</span></span>
<span><span class="co"># of the day, so that every frame has the same extent</span></span>
<span><span class="va">bbox</span> <span class="op">=</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_bbox.html" class="external-link">st_bbox</a></span><span class="op">(</span><span class="va">positions</span><span class="op">)</span></span>
<span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">time</span> <span class="kw">in</span> <span class="va">times</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">current_pos</span> <span class="op">=</span> <span class="fu">snapshot_positions</span><span class="op">(</span><span class="va">positions</span>, <span class="va">time</span><span class="op">)</span></span>
<span>  <span class="va">p</span> <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">current_pos</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_void</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html" class="external-link">geom_sf</a></span><span class="op">(</span>size<span class="op">=</span><span class="fl">0.3</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/lims.html" class="external-link">xlim</a></span><span class="op">(</span><span class="va">bbox</span><span class="op">$</span><span class="va">xmin</span>, <span class="va">bbox</span><span class="op">$</span><span class="va">xmax</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/lims.html" class="external-link">ylim</a></span><span class="op">(</span><span class="va">bbox</span><span class="op">$</span><span class="va">ymin</span>, <span class="va">bbox</span><span class="op">$</span><span class="va">ymax</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="co"># add the current time as the title</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ggtitle</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/format.html" class="external-link">format</a></span><span class="op">(</span><span class="va">time</span>, <span class="st">"%B %d, %H:%M"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># save the frame, using the Unix timestamp in the filename</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsave.html" class="external-link">ggsave</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">framedir</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"time"</span>, <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">time</span><span class="op">)</span>, <span class="st">".png"</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    width<span class="op">=</span><span class="fl">6</span>, height<span class="op">=</span><span class="fl">6</span>, dpi<span class="op">=</span><span class="fl">150</span>, bg<span class="op">=</span><span class="st">"white"</span>, plot <span class="op">=</span> <span class="va">p</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>Lastly, we render all the frames we created to an animated GIF:</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://r-rust.r-universe.dev/gifski/reference/gifski.html" class="external-link">gifski</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/list.files.html" class="external-link">list.files</a></span><span class="op">(</span><span class="va">framedir</span>, full.names<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>  <span class="st">"figures/nyc_bus_anim.gif"</span>,</span>
<span>  <span class="co"># twenty minutes per second</span></span>
<span>  delay <span class="op">=</span> <span class="fl">1</span> <span class="op">/</span> <span class="fl">20</span>,</span>
<span>  <span class="co"># match resolution of input files (6 in by 6 in at 150 dpi)</span></span>
<span>  width <span class="op">=</span> <span class="fl">900</span>,</span>
<span>  height <span class="op">=</span> <span class="fl">900</span></span>
<span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] "figures/nyc_bus_anim.gif"</span></span></code></pre>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">knitr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/knitr/man/include_graphics.html" class="external-link">include_graphics</a></span><span class="op">(</span><span class="st">"figures/nyc_bus_anim.gif"</span><span class="op">)</span></span></code></pre></div>
<div class="figure">
<img src="figures/nyc_bus_anim.gif" alt="Animation of a day of buses in NYC; each bus is a black dot, and its position is shown every minute."><p class="caption">
plot of chunk unnamed-chunk-12
</p>
</div>
<p>And finally, clean up after ourselves by removing the temporary
directory.</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/unlink.html" class="external-link">unlink</a></span><span class="op">(</span><span class="va">framedir</span>, recursive<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="extracting-trajectories">Extracting trajectories<a class="anchor" aria-label="anchor" href="#extracting-trajectories"></a>
</h2>
<p>We can also extract the trajectories that particular vehicles took
over the course of the day. We do this by grouping by vehicle ID (we
could also group by trip ID to get single runs), and then summarizing
and converting the combined points into a linestring (line feature).</p>
<p>This is quite slow, which seems to be related to the use of
<code>st_cast</code>; this issue needs further investigation.</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">trajectories</span> <span class="op">=</span> <span class="va">positions</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html" class="external-link">arrange</a></span><span class="op">(</span><span class="va">vehicle_id</span>, <span class="va">trip_id</span>, <span class="va">timestamp</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">vehicle_id</span>, <span class="va">trip_id</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarize</a></span><span class="op">(</span>do_union<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_cast.html" class="external-link">st_cast</a></span><span class="op">(</span><span class="st">"LINESTRING"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## `summarise()` has grouped output by 'vehicle_id'. You can override using the `.groups` argument.</span></span></code></pre>
<p>We can then plot all of those trajectories over the course of the
day:</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">trajectories</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_void</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html" class="external-link">geom_sf</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<div class="figure">
<img src="figures/unnamed-chunk-15-1.png" alt="Trajectories of all trips showing the bus network of NYC as a bunch of lines, one for the path taken by each vehicle, on a white background."><p class="caption">
plot of chunk unnamed-chunk-15
</p>
</div>
<p>Or extract a single trajectory:</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">trajectories</span><span class="op">[</span><span class="fl">2</span>, <span class="op">]</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_void</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html" class="external-link">geom_sf</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<div class="figure">
<img src="figures/unnamed-chunk-16-1.png" alt="A single vehicle's trajectory, a line from southeast to northwest."><p class="caption">
plot of chunk unnamed-chunk-16
</p>
</div>
<p>Or extract a single trajectory and combine it with times:</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">trajectory</span> <span class="op">=</span> <span class="va">trajectories</span><span class="op">[</span><span class="fl">2</span>, <span class="op">]</span></span>
<span><span class="va">points</span> <span class="op">=</span> <span class="va">positions</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">vehicle_id</span> <span class="op">==</span> <span class="va">trajectory</span><span class="op">$</span><span class="va">vehicle_id</span> <span class="op">&amp;</span> <span class="va">trip_id</span> <span class="op">==</span> <span class="va">trajectory</span><span class="op">$</span><span class="va">trip_id</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html" class="external-link">geom_sf</a></span><span class="op">(</span>data<span class="op">=</span><span class="va">trajectory</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html" class="external-link">geom_sf</a></span><span class="op">(</span>data<span class="op">=</span><span class="va">points</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="co"># label the times the bus reached each point</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html" class="external-link">geom_sf_label</a></span><span class="op">(</span></span>
<span>    data<span class="op">=</span><span class="va">points</span>,</span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>label<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/format.html" class="external-link">format</a></span><span class="op">(</span><span class="va">timestamp</span>, <span class="st">"%H:%M"</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    position <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/position_nudge.html" class="external-link">position_nudge</a></span><span class="op">(</span>x<span class="op">=</span><span class="fl">120</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_void</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<div class="figure">
<img src="figures/unnamed-chunk-17-1.png" alt="The same trajectory, but now with times along it; it starts at 5:47 and ends at 6:18"><p class="caption">
plot of chunk unnamed-chunk-17
</p>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Matthew Bhagat-Conway.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.2.0.</p>
</div>

    </footer>
</div>





  </body>
</html>
